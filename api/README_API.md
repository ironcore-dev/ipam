## Purpose 
This package is the canonical location of the autogenerated files in 'go' format. Most likely interaction with this repository is as a dependency of chart/values, config and controllers folderes.

## Getting started
### Required tools

Following tools are required to work on that package.

- k8s cluster access to deploy and test the result (via minikube or docker desktop locally)
- [make](https://www.gnu.org/software/make/) - to execute build goals
- [golang](https://golang.org/) - to compile the code
- [kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl/) - to interact with k8s cluster via CLI (command-line interface)
- [kustomize](https://kustomize.io/) - to generate deployment configs
- [kubebuilder](https://book.kubebuilder.io) - framework to build operators
- [operator framework](https://operatorframework.io/) - framework to maintain project structure
- [helm](https://helm.sh/) - the package manager for k8s that works with helm charts to define, install, and upgrade even the most complex application.
- [cert-manager](https://cert-manager.io/) - to issue certificates for webhook endpoints


## Development

### Adding a new API version

One should not modify API once it got to be used.
Instead, in order to introduce breaking changes to the API, a new API version should be created.

First, move the existing controller to a different file, as generator will try to put a new controller into the same location, e.g.

    mv controllers/network_controller.go controllers/network_v1alpha1_controller.go

After that, add a new API version

    operator-sdk create api --group machine --version v1alpha2 --kind Network --resource --controller

Do modifications in a new CR, add a new controller to `main.go`.

Following actions should be applied to other parts of project:
- regenerate code and configs with `make install`
- add a client to client set for the new API version
- alter Helm chart with new CRD spec

### Conversion webhooks

By adding a new API you should remember that Kubernetes can not store different versions of objects within the same kind. To solve the problem, you can use `conversion webhook` 

If problem running webhook occures, use `ENABLE_WEBHOOKS=false` env var to disable them on local run.

### Deprecating old APIs

Since there is no version deprecation marker available, old APIs may be deprecated with `kustomize` patches

Describe deprecation status and deprecation warning in patch file, e.g. `crd_patch.yaml`

```
- op: add
  path: "/spec/versions/0/deprecated"
  value: true
- op: add
  path: "/spec/versions/0/deprecationWarning"
  value: "This API version is deprecated. Check documentation for migration instructions."
```

Add patch instructions to `kustomization.yaml`

```
patchesJson6902:
  - target:
      version: v1
      group: apiextensions.k8s.io
      kind: CustomResourceDefinition
      name: ipam.onmetal.de
    path: crd_patch.yaml
```

When you are ready to drop the support for the API version, give CRD a `+kubebuilder:skipversion` marker,
or just remove it completely from the code base.

This includes:
- API objects
- client
- controller
